<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.sist.web.dao.CourseListDao">

<!--  게시판 리스트 resultMap -->
<resultMap type="com.sist.web.model.CourseList" id="courseListResultMap">
   <id column="BRD_SEQ" property="brdSeq"/>
   <result column="BRD_TITLE" property="brdTitle"/>
   <result column="BRD_CONTENT" property="brdContent"/>
   <result column="BRD_READ_CNT" property="brdReadCnt"/>
   <result column="REG_DATE" property="regDate"/>
   <result column="MOD_DATE" property="modDate"/>
   <result column="DEL_DATE" property="delDate"/>
   <result column="COURSE_CODE" property="courseCode"/>
   <result column="USER_ID" property="userId"/>
   <result column="USER_NAME" property="userName" />
   <result column="BRD_PARENT" property="brdParent"/>
   <result column="COURSE_NAME" property="courseName"/>
   <result column="STATUs" property="status"/>
   <result column="RATING" property="rating"/>
   <result column="USER_EMAIL" property="userEmail"/>
   <result column="BRD_RATING" property="brdRating"/>
   <result column="BRD_ORDER" property="brdOrder"/>
   <result column="BRD_GROUP" property="brdGroup"/>
   <result column="CLASS_CODE" property="classCode"/>
   <result column="USER_PROFILE" property="userProfile" />
</resultMap>


<!--  게시판 파일 리스트 resultMap -->
<resultMap type="com.sist.web.model.CourseListFile" id="courseListFileResultMap">
   <id column="FILE_SEQ" property="fileSeq"/>
   <result column="BRD_SEQ" property="brdSeq"/>
   <result column="FILE_NAME" property="fileName"/>
   <result column="FILE_ORG_NAME" property="fileOrgName"/>
   <result column="FILE_EXT" property="fileExt"/>
   <result column="FILE_SIZE" property="fileSize"/>
   <result column="REG_DATE" property="regDate"/>
   <result column="COURSE_CODE" property="courseCode"/>
</resultMap>


<!--  코스 공지사항 게시판 조회 -->
<select id="courseNoticeList" parameterType="com.sist.web.model.CourseList" resultMap="courseListResultMap">
      SELECT  RNUM,
              BRD_SEQ,
              BRD_TITLE,
              BRD_CONTENT,
              BRD_READ_CNT,
              REG_DATE,
              MOD_DATE,
              DEL_DATE,
              COURSE_CODE,
              USER_ID,
              USER_NAME,
              COURSE_NAME
      FROM    (SELECT     ROWNUM RNUM,
                          BRD_SEQ,
                          BRD_TITLE,
                          BRD_CONTENT,
                          BRD_READ_CNT,
                          REG_DATE,
                          MOD_DATE,
                          DEL_DATE,
                          COURSE_CODE,
                          USER_ID,
                          USER_NAME,
                          COURSE_NAME
                  FROM    (SELECT     BRD_SEQ,
                                      BRD_TITLE,
                                      BRD_CONTENT,
                                      BRD_READ_CNT,
                                      TO_CHAR(A.REG_DATE, 'YYYY.MM.DD') REG_DATE,
                                      TO_CHAR(A.MOD_DATE, 'YYYY.MM.DD HH24:MI:SS') MOD_DATE,
                                      TO_CHAR(DEL_DATE, 'YYYY.MM.DD HH24:MI:SS') DEL_DATE,
                                      A.COURSE_CODE COURSE_CODE,
                                      A.USER_ID,
                                      USER_NAME,
                                      COURSE_NAME
                              FROM    EDU_COURSE_NOTICE A, EDU_TEACHER B, EDU_COURSE C
                              WHERE   A.USER_ID = B.USER_ID
                                AND   DEL_DATE IS NULL
                                AND   A.COURSE_CODE = C.COURSE_CODE
                                AND   B.USER_ID = #{userId}
                              
                 <if test='courseCode != null and courseCode != "" and courseCode != 0'>       
                                AND   A.COURSE_CODE = #{courseCode}
                 </if>
                              
                              
                <if test='searchType != null and searchType != "" and searchValue != null and searchValue != ""'>
                      <choose>
                         <when test='searchType == "1"'>
                           AND USER_NAME LIKE '%' || #{searchValue} || '%'
                         </when>
                           
                         <when test='searchType == "2"'>
                           AND BRD_TITLE LIKE '%' || #{searchValue} || '%'
                         </when>
                         
                         <when test='searchType == "3"'>
                           AND DBMS_LOB.INSTR(BRD_CONTENT, #{searchValue}) > 0
                          </when>
                     </choose>
                </if>                                 
                             
                              
                              ORDER BY BRD_SEQ DESC))
      WHERE RNUM <![CDATA[>=]]> ${startRow}
        AND RNUM <![CDATA[<=]]> ${endRow}
</select>


<!--  코스 공지 게시판 글 수 조회 -->
<select id="courseNoticeListCount" parameterType="com.sist.web.model.CourseList" resultType="long">
      SELECT COUNT(BRD_SEQ)
        FROM EDU_COURSE_NOTICE A, EDU_TEACHER B
       WHERE A.USER_ID = B.USER_ID
         AND   DEL_DATE IS NULL
         AND   B.USER_ID = #{userId}
         
        <if test='courseCode != null and courseCode != "" and courseCode != 0'>       
                       AND   A.COURSE_CODE = #{courseCode}
        </if>
         
       <if test='searchType != null and searchType != "" and searchValue != null and searchValue != ""'>
           <choose>
              <when test='searchType == "1"'>
                AND USER_NAME LIKE '%' || #{searchValue} || '%'
              </when>
                
              <when test='searchType == "2"'>
                AND BRD_TITLE LIKE '%' || #{searchValue} || '%'
              </when>
              
              <when test='searchType == "3"'>
                AND DBMS_LOB.INSTR(BRD_CONTENT, #{searchValue}) > 0
               </when>
          </choose>
     </if>         
         
</select>

<!--  코스 공지사항 게시판 게시글 상세조회 -->
<select id="courseNoticeView" parameterType="com.sist.web.model.CourseList" resultMap="courseListResultMap">
      SELECT  BRD_SEQ,
           BRD_TITLE,
           BRD_CONTENT,
           BRD_READ_CNT,
           TO_CHAR(A.REG_DATE, 'YY.MM.DD HH24:MI') REG_DATE,
           TO_CHAR(A.MOD_DATE, 'YY.MM.DD HH24:MI') MOD_DATE,
           TO_CHAR(A.DEL_DATE, 'YY.MM.DD HH24:MI') DEL_DATE,
           COURSE_CODE,
           A.USER_ID,
           USER_NAME,
           B.USER_EMAIL
     FROM  EDU_COURSE_NOTICE A, EDU_TEACHER B
    WHERE  A.USER_ID = B.USER_ID
   
<if test='courseCode != null and courseCode != "" and courseCode != 0'> 
      AND  COURSE_CODE = #{courseCode}
</if>      
      
      AND  BRD_SEQ = #{brdSeq}
</select>

<!-- 코스 공지 게시글 조회수 증가 -->
<update id="courseNoticeReadCntPlus" parameterType="long">
   UPDATE EDU_COURSE_NOTICE
      SET BRD_READ_CNT = BRD_READ_CNT + 1
    WHERE BRD_SEQ = #{value}
</update>

<!--  코스 공지사항 게시판 이전글 조회 -->
<select id="courseNoticePrevView" parameterType="com.sist.web.model.CourseList" resultMap="courseListResultMap">
      SELECT  BRD_SEQ,
              BRD_TITLE,
              BRD_CONTENT,
              BRD_READ_CNT,
              TO_CHAR(A.REG_DATE, 'YY.MM.DD HH24:MI') REG_DATE,
              TO_CHAR(A.MOD_DATE, 'YY.MM.DD HH24:MI') MOD_DATE,
              TO_CHAR(A.DEL_DATE, 'YY.MM.DD HH24:MI') DEL_DATE,
              COURSE_CODE,
              A.USER_ID,
              USER_NAME
        FROM  EDU_COURSE_NOTICE A, EDU_TEACHER B
       WHERE  A.USER_ID = B.USER_ID
         AND  BRD_SEQ <![CDATA[<]]> #{brdSeq}
         AND  DEL_DATE IS NULL
         AND  COURSE_CODE = #{courseCode}
      ORDER BY BRD_SEQ DESC
      FETCH FIRST 1 ROWS ONLY
</select>

<!--  코스 공지사항 게시판 다음글 조회 -->
<select id="courseNoticeNextView" parameterType="com.sist.web.model.CourseList" resultMap="courseListResultMap">
      SELECT  BRD_SEQ,
              BRD_TITLE,
              BRD_CONTENT,
              BRD_READ_CNT,
              TO_CHAR(A.REG_DATE, 'YY.MM.DD HH24:MI') REG_DATE,
              TO_CHAR(A.MOD_DATE, 'YY.MM.DD HH24:MI') MOD_DATE,
              TO_CHAR(A.DEL_DATE, 'YY.MM.DD HH24:MI') DEL_DATE,
              COURSE_CODE,
              A.USER_ID,
              USER_NAME
        FROM  EDU_COURSE_NOTICE A, EDU_TEACHER B
       WHERE  A.USER_ID = B.USER_ID
         AND  BRD_SEQ <![CDATA[>]]> #{brdSeq}
         AND  DEL_DATE IS NULL
         AND  COURSE_CODE = #{courseCode}
      ORDER BY BRD_SEQ ASC
      FETCH FIRST 1 ROWS ONLY
</select>

<!--  코스 공지 게시글 작성 -->
<insert id="courseNoticeWrite" parameterType="com.sist.web.model.CourseList">

   <selectKey resultType="long"  keyProperty="brdSeq" order="BEFORE">
      SELECT SEQ_COURSE_NOTICE_SEQ.NEXTVAL FROM DUAL
   </selectKey>

      INSERT INTO EDU_COURSE_NOTICE (
          BRD_SEQ,
          BRD_TITLE,
          BRD_CONTENT,
          BRD_READ_CNT,
          REG_DATE,
          MOD_DATE,
          DEL_DATE,
          COURSE_CODE,
          USER_ID
      ) VALUES (
            #{brdSeq},
          #{brdTitle},
          #{brdContent},
          0,
          SYSDATE,
          SYSDATE,
          NULL,
          #{courseCode},
          #{userId}
      )
</insert>

<!--  코스 공지 게시글 수정 -->
<update id="courseNoticeUpdate" parameterType="com.sist.web.model.CourseList">
         UPDATE EDU_COURSE_NOTICE
            SET BRD_TITLE = #{brdTitle},
                BRD_CONTENT = #{brdContent},
                MOD_DATE = SYSDATE
          WHERE BRD_SEQ = #{brdSeq}
</update>

<!--  코스 공지 게시글 삭제 -->
<update id="courseNoticeDelete" parameterType="long">
      UPDATE EDU_COURSE_NOTICE
         SET DEL_DATE = SYSDATE
       WHERE BRD_SEQ = #{brdSeq}
</update>









<!-- 강사 페이지 강사별 공지 5개 조회 -->
<select id="teachNoticeRec" parameterType="String" resultMap="courseListResultMap">
         SELECT
             RNUM,
             BRD_SEQ,
             BRD_TITLE,
             BRD_CONTENT,
             BRD_READ_CNT,
             REG_DATE,
             MOD_DATE,
             DEL_DATE,
             COURSE_CODE,
             USER_ID
         FROM (SELECT
                     ROWNUM RNUM,
                     BRD_SEQ,
                     BRD_TITLE,
                     BRD_CONTENT,
                     BRD_READ_CNT,
                     REG_DATE,
                     MOD_DATE,
                     DEL_DATE,
                     COURSE_CODE,
                     USER_ID
                 FROM
                     (SELECT
                         BRD_SEQ,
                         BRD_TITLE,
                         BRD_CONTENT,
                         BRD_READ_CNT,
                         REG_DATE,
                         MOD_DATE,
                         DEL_DATE,
                         COURSE_CODE,
                         USER_ID
                     FROM
                         EDU_COURSE_NOTICE
                     WHERE
                         USER_ID = #{value}
                     AND
                        DEL_DATE IS NULL
                     ORDER BY
                         REG_DATE DESC))
         WHERE
             RNUM <![CDATA[>=]]> 1
         AND
             RNUM <![CDATA[<=]]> 5
</select>


<!--  과목별 최신순 공지 4개 조회 -->
<select id="classNotcieRec" parameterType="int" resultMap="courseListResultMap">
         SELECT
             RNUM,
             BRD_SEQ,
             BRD_TITLE,
             BRD_CONTENT,
             BRD_READ_CNT,
             REG_DATE,
             MOD_DATE,
             DEL_DATE,
             COURSE_CODE,
             USER_ID,
             USER_NAME
         FROM (SELECT
                 ROWNUM RNUM,
                 BRD_SEQ,
                 BRD_TITLE,
                 BRD_CONTENT,
                 BRD_READ_CNT,
                 REG_DATE,
                 MOD_DATE,
                 DEL_DATE,
                 COURSE_CODE,
                 USER_ID,
                 USER_NAME
             FROM
                 (SELECT
                     BRD_SEQ,
                     BRD_TITLE,
                     BRD_CONTENT,
                     BRD_READ_CNT,
                     A.REG_DATE REG_DATE,
                     A.MOD_DATE MOD_DATE,
                     A.DEL_DATE DEL_DATE,
                     COURSE_CODE,
                     A.USER_ID USER_ID,
                     B.USER_NAME USER_NAME
                 FROM
                     EDU_COURSE_NOTICE A, EDU_TEACHER B
                 WHERE
                     A.USER_ID = B.USER_ID
                 AND
                     A.DEL_DATE IS NULL
                 AND 
                     B.CLASS_CODE = #{value}
                     
                 ORDER BY REG_DATE DESC))
         WHERE
             RNUM <![CDATA[>=]]> 1
         AND
             RNUM <![CDATA[<=]]> 4
</select>






<!--  ############################################################################################### -->



<!--  코스 QnA 게시판 게시글 조회 -->
<select id="courseQnAList" parameterType="com.sist.web.model.CourseList" resultMap="courseListResultMap">


   SELECT  RNUM,
           BRD_SEQ,
           BRD_TITLE,
           BRD_CONTENT,
           BRD_READ_CNT,
           BRD_PARENT,
           REG_DATE,
           MOD_DATE,
           DEL_DATE,
           COURSE_CODE,
           USER_ID,
           COURSE_NAME,
           USER_NAME,
           STATUS,
           RATING,
           BRD_GROUP,
           BRD_ORDER
   FROM    (SELECT ROWNUM RNUM,
                   BRD_SEQ,
                   BRD_TITLE,
                   BRD_CONTENT,
                   BRD_READ_CNT,
                   BRD_PARENT,
                   REG_DATE,
                   MOD_DATE,
                   DEL_DATE,
                   COURSE_CODE,
                   USER_ID,
                   COURSE_NAME,
                   USER_NAME,
                   STATUS,
                   RATING,
                   BRD_GROUP,
                   BRD_ORDER
           FROM    (SELECT     BRD_SEQ,
                          BRD_TITLE,
                          BRD_CONTENT,
                          BRD_READ_CNT,
                          BRD_PARENT,
                          TO_CHAR(A.REG_DATE, 'YYYY.MM.DD') REG_DATE,
                          MOD_DATE,
                          DEL_DATE,
                         A.COURSE_CODE COURSE_CODE,
                         A.USER_ID USER_ID,
                          COURSE_NAME,
                          USER_NAME,
                          STATUS,
                          RATING,
                          BRD_GROUP,
                          BRD_ORDER
                  FROM    EDU_COURSE_QNA A
                  LEFT JOIN (
                     SELECT   B.USER_ID USER_ID,
                              B.USER_NAME USER_NAME,
                              B.STATUS STATUS,
                              B.RATING RATING
                      FROM    EDU_USER B
                      
                      UNION ALL
                      
                      SELECT  C.USER_ID USER_ID,
                              C.USER_NAME USER_NAME,
                              C.STATUS STATUS,
                              C.RATING RATING
                      FROM    EDU_TEACHER C
                      
                  <if test='courseCode == null and courseCode != "" and courseCode == 0'>
                      WHERE   C.USER_ID = ${userId}         
                  </if>    
                      
                  ) USER_DATE
                  ON A.USER_ID = USER_DATE.USER_ID,
                      EDU_COURSE C
                  WHERE A.COURSE_CODE = C.COURSE_CODE
                    AND   DEL_DATE IS NULL
                       AND  A.COURSE_CODE IN (SELECT COURSE_CODE 
                                            FROM EDU_COURSE 
                                            WHERE USER_ID = #{teacherId})
                       
                  <if test='courseCode != null and courseCode != "" and courseCode != 0'>       
                       AND  A.COURSE_CODE = #{courseCode}
                  </if>  
         
                       <if test='myBrdChk != null and myBrdChk != "" and myBrdChk == "Y"'>
                            AND A.BRD_GROUP IN (
                              SELECT BRD_GROUP
                              FROM EDU_COURSE_QNA
                              WHERE USER_ID = #{loginUserId}
                          )
                       </if>
                    
                        <if test='searchType != null and searchType != "" and searchValue != null and searchValue != ""'>
                            <choose>
                               <when test='searchType == "1"'>
                                 AND USER_NAME LIKE '%' || #{searchValue} || '%'
                               </when>
                                 
                               <when test='searchType == "2"'>
                                 AND BRD_TITLE LIKE '%' || #{searchValue} || '%'
                               </when>
                               
                               <when test='searchType == "3"'>
                                 AND DBMS_LOB.INSTR(BRD_CONTENT, #{searchValue}) > 0
                                </when>
                           </choose>
                      </if>  
                      
                      
                  ORDER BY BRD_GROUP DESC, BRD_ORDER))
                  
       WHERE
           RNUM <![CDATA[>=]]> #{startRow}
       AND
           RNUM <![CDATA[<=]]> #{endRow}
         
</select>


<!--  코스 QnA 게시판 글 수 조회 -->
<select id="courseQnAListCount" parameterType="com.sist.web.model.CourseList" resultType="long">
         SELECT  COUNT(BRD_SEQ)
         FROM    EDU_COURSE_QNA A
         LEFT JOIN (
            SELECT   B.USER_ID USER_ID,
                     B.USER_NAME USER_NAME,
                     B.STATUS STATUS,
                     B.RATING RATING
             FROM    EDU_USER B
             
             UNION ALL
             
             SELECT  C.USER_ID USER_ID,
                     C.USER_NAME USER_NAME,
                     C.STATUS STATUS,
                     C.RATING RATING
             FROM    EDU_TEACHER C
         ) USER_DATE
         ON A.USER_ID = USER_DATE.USER_ID,
             EDU_COURSE C
         WHERE A.COURSE_CODE = C.COURSE_CODE
           AND A.DEL_DATE IS NULL
              AND  A.COURSE_CODE IN (SELECT COURSE_CODE 
                                   FROM EDU_COURSE 
                                   WHERE USER_ID = #{teacherId})
                                   
         <if test='courseCode == null and courseCode != "" and courseCode == 0'>
             WHERE   C.USER_ID = ${userId}         
         </if>  
              
         <if test='courseCode != null and courseCode != "" and courseCode != 0'>       
              AND  A.COURSE_CODE = #{courseCode}
         </if>    
           
           <if test='myBrdChk != null and myBrdChk != "" and myBrdChk == "Y"'>
                AND A.BRD_GROUP IN (
                  SELECT BRD_GROUP
                  FROM EDU_COURSE_QNA
                  WHERE USER_ID = #{loginUserId}
              )
           </if>
           
          <if test='searchType != null and searchType != "" and searchValue != null and searchValue != ""'>
                <choose>
                   <when test='searchType == "1"'>
                     AND USER_NAME LIKE '%' || #{searchValue} || '%'
                   </when>
                     
                   <when test='searchType == "2"'>
                     AND BRD_TITLE LIKE '%' || #{searchValue} || '%'
                   </when>
                   
                   <when test='searchType == "3"'>
                     AND DBMS_LOB.INSTR(BRD_CONTENT, #{searchValue}) > 0
                    </when>
               </choose>
          </if>  
</select>


<!--  코스 QnA 게시판 내가 쓴 글 조회 -->
<select id="courseQnAMyBrdList" parameterType="com.sist.web.model.CourseList" resultMap="courseListResultMap">
         SELECT  BRD_SEQ,
                 BRD_TITLE,
                 BRD_CONTENT,
                 BRD_READ_CNT,
                 BRD_PARENT,
                 A.REG_DATE,
                 MOD_DATE,
                 DEL_DATE,
                 A.COURSE_CODE,
                 A.USER_ID,
                 COURSE_NAME,
                 USER_NAME,
                 STATUS,
                 RATING
         FROM    EDU_COURSE_QNA A
         LEFT JOIN (
            SELECT   B.USER_ID USER_ID,
                     B.USER_NAME USER_NAME,
                     B.STATUS STATUS,
                     B.RATING RATING
             FROM    EDU_USER B
             
             UNION ALL
             
             SELECT  C.USER_ID USER_ID,
                     C.USER_NAME USER_NAME,
                     C.STATUS STATUS,
                     C.RATING RATING
             FROM    EDU_TEACHER C
         ) USER_DATE
         ON A.USER_ID = USER_DATE.USER_ID,
             EDU_COURSE C
         WHERE A.COURSE_CODE = C.COURSE_CODE
           AND A.COURSE_CODE = #{courseCode}
           AND A.DEL_DATE IS NULL
           AND A.BRD_GROUP IN (
               SELECT BRD_GROUP
               FROM EDU_COURSE_QNA
               WHERE USER_ID = #{loginUserId}
           )
         ORDER BY BRD_GROUP DESC, BRD_ORDER
</select>

   <!--  마이페이지 QnA 게시판 댓글 -->
   <select id="myPageQnACommentSelect" parameterType="long" resultType="int">
       SELECT COUNT(*)
         FROM EDU_COURSE_QNA
        WHERE BRD_PARENT = #{brdSeq}
          AND DEL_DATE IS NULL
   </select>







<!-- ################################################################################################## -->


<select id="courseMyPageQnaList" parameterType="com.sist.web.model.CourseList" resultMap="courseListResultMap">

   SELECT BRD_SEQ,
       BRD_TITLE,
       BRD_CONTENT,
       BRD_READ_CNT,
       BRD_PARENT,
       REG_DATE,
       MOD_DATE,
       DEL_DATE,
       COURSE_CODE,
       BRD_GROUP,
       BRD_ORDER,
       USER_ID,
       CLASS_CODE
  FROM (SELECT ROWNUM AS RNUM,
            BRD_SEQ,
            BRD_TITLE,
            BRD_CONTENT,
            BRD_READ_CNT,
            BRD_PARENT,
            REG_DATE,
            MOD_DATE,
            DEL_DATE,
            COURSE_CODE,
            BRD_GROUP,
            BRD_ORDER,
            USER_ID,
            CLASS_CODE
          FROM (SELECT A.BRD_SEQ,
                       NVL(A.BRD_TITLE, '') BRD_TITLE,
                       NVL(A.BRD_CONTENT, '') BRD_CONTENT,
                       NVL(A.BRD_READ_CNT, '') BRD_READ_CNT,
                       NVL(A.BRD_PARENT, '') BRD_PARENT,
                       NVL(TO_CHAR(A.REG_DATE, 'YYYY.MM.DD'), '') REG_DATE,
                       NVL(TO_CHAR(A.MOD_DATE, 'YYYY.MM.DD'), '') MOD_DATE,
                       NVL(TO_CHAR(A.DEL_DATE, 'YYYY.MM.DD'), '') DEL_DATE,
                       NVL(A.COURSE_CODE, '') COURSE_CODE,                  
                       NVL(A.BRD_GROUP, '') BRD_GROUP,
                       NVL(A.BRD_ORDER, '') BRD_ORDER,
                       C.USER_ID,
                       B.CLASS_CODE
                  FROM EDU_COURSE_QNA A, EDU_TEACHER B, EDU_COURSE C
                 WHERE A.USER_ID = #{userId}
                   AND A.BRD_PARENT = 0   
                   AND A.DEL_DATE IS NULL
                   AND A.COURSE_CODE = C.COURSE_CODE
                   AND C.USER_ID = B.USER_ID
                   
                ORDER BY A.BRD_SEQ DESC))
       WHERE RNUM <![CDATA[>=]]> #{startRow}
         AND RNUM <![CDATA[<=]]> #{endRow}
</select>

<!-- QNA(문의사항) 답글 유무 확인 -->
<select id="countRepliesMyPageBrdSeq" resultType="int" parameterType="long">
    SELECT COUNT(*)
      FROM EDU_COURSE_QNA
     WHERE BRD_PARENT = #{brdSeq}
</select>


<!-- ################################################################################################## -->





<!--  코스 QnA 게시판 내가 쓴 글 개수 조회 -->
<select id="courseQnAMyBrdListCount"  parameterType="com.sist.web.model.CourseList" resultType="long">
         SELECT NVL(COUNT(BRD_SEQ), 0)
           FROM EDU_COURSE_QNA
          WHERE USER_ID = #{userId}
          AND   DEL_DATE IS NULL
</select>

<!--  코스 QnA 게시글 상세보기 -->
<select id="courseNoticeQnAViewList" parameterType="com.sist.web.model.CourseList" resultMap="courseListResultMap">
      SELECT  BRD_SEQ,
              BRD_TITLE,
              BRD_CONTENT,
              BRD_READ_CNT,
              BRD_PARENT,
              TO_CHAR(A.REG_DATE, 'YY.MM.DD HH24:MI') REG_DATE,
              MOD_DATE,
              DEL_DATE,
              A.COURSE_CODE,
              A.USER_ID,
              COURSE_NAME,
              USER_NAME,
              STATUS,
              RATING,
              USER_EMAIL
      FROM    EDU_COURSE_QNA A
      LEFT JOIN (
         SELECT   B.USER_ID USER_ID,
                  B.USER_NAME USER_NAME,
                  B.STATUS STATUS,
                  B.RATING RATING,
                  B.USER_EMAIL
          FROM    EDU_USER B
          
          UNION ALL
          
          SELECT  C.USER_ID USER_ID,
                  C.USER_NAME USER_NAME,
                  C.STATUS STATUS,
                  C.RATING RATING,
                  C.USER_EMAIL
          FROM    EDU_TEACHER C
      ) USER_DATE
      ON A.USER_ID = USER_DATE.USER_ID,
          EDU_COURSE C
      WHERE A.COURSE_CODE = C.COURSE_CODE
        AND A.COURSE_CODE = #{courseCode}
        AND DEL_DATE IS NULL
        
        AND A.BRD_GROUP IN (
            SELECT BRD_GROUP
            FROM EDU_COURSE_QNA
            WHERE BRD_SEQ = #{brdSeq}
        )
        
      ORDER BY BRD_GROUP DESC, BRD_ORDER
   
</select>

<!-- 코스 QnA 게시글 조회수 증가 -->
<update id="courseQnAReadCntPlus" parameterType="long">
   UPDATE EDU_COURSE_QNA
      SET BRD_READ_CNT = BRD_READ_CNT + 1
    WHERE BRD_SEQ = #{value}
</update>


<!--  코스 QnA 게시글 작성 -->
<insert id="courseQnAWrite" parameterType="com.sist.web.model.CourseList">

   <selectKey resultType="long"  keyProperty="brdSeq" order="BEFORE">
      SELECT SEQ_COURSE_QNA_SEQ.NEXTVAL FROM DUAL
   </selectKey>

      INSERT INTO EDU_COURSE_QNA (
          BRD_SEQ,
          BRD_TITLE,
          BRD_CONTENT,
          BRD_READ_CNT,
          BRD_PARENT,
          REG_DATE,
          MOD_DATE,
          DEL_DATE,
          COURSE_CODE,
          USER_ID,
          BRD_GROUP,
          BRD_ORDER
      ) VALUES (
          #{brdSeq},
          #{brdTitle},
          #{brdContent},
          0,
          0,
          SYSDATE,
          SYSDATE,
          NULL,
          #{courseCode},
          #{userId},
          #{brdSeq},
          0
      )

</insert>

<!--  코스 QnA 첨부파일 등록 -->
<insert id="courseQnAFileInsert" parameterType="com.sist.web.model.CourseListFile">
      INSERT INTO EDU_COURSE_QNA_FILE (
          FILE_SEQ,
          BRD_SEQ,
          FILE_NAME,
          FILE_ORG_NAME,
          FILE_EXT,
          FILE_SIZE,
          REG_DATE,
          COURSE_CODE
      ) VALUES (
          #{fileSeq},
          #{brdSeq},
          #{fileName},
          #{fileOrgName},
          #{fileExt},
          #{fileSize},
          SYSDATE,
          #{courseCode}
      )
</insert>

<!--  코스 QnA BRD_GROUP의 BRD_ORDER 수정 -->
<update id="courseQnAGroupOrderUpdate" parameterType="com.sist.web.model.CourseList">
      UPDATE EDU_COURSE_QNA
         SET BRD_ORDER = BRD_ORDER + 1
       WHERE BRD_GROUP = #{brdGroup}
         AND BRD_ORDER <![CDATA[>=]]> #{brdOrder}
</update>

<!-- 게시글 답변 등록 -->
<insert id="courseQnAReplyInsert" parameterType="com.sist.web.model.CourseList">
   <selectKey resultType="long"  keyProperty="brdSeq" order="BEFORE">
      SELECT SEQ_COURSE_QNA_SEQ.NEXTVAL FROM DUAL
   </selectKey>
   
      INSERT INTO EDU_COURSE_QNA (
          BRD_SEQ,
          BRD_TITLE,
          BRD_CONTENT,
          BRD_READ_CNT,
          BRD_PARENT,
          REG_DATE,
          MOD_DATE,
          DEL_DATE,
          COURSE_CODE,
          USER_ID,
          BRD_GROUP,
          BRD_ORDER
      ) VALUES (
          #{brdSeq},
          #{brdTitle},
          #{brdContent},
          0,
          #{brdParent},
          SYSDATE,
          SYSDATE,
          NULL,
          #{courseCode},
          #{userId},
          #{brdGroup},
          #{brdOrder}
      )
   
</insert>





<!-- 코스 QnA 상세보기 파일 조회 -->
<select id="courseQnAFileSelect" parameterType="long" resultMap="courseListFileResultMap">
      SELECT  FILE_SEQ,
              BRD_SEQ,
              FILE_NAME,
              FILE_ORG_NAME,
              FILE_EXT,
              FILE_SIZE,
              REG_DATE,
              COURSE_CODE
      FROM    EDU_COURSE_QNA_FILE
      WHERE   BRD_SEQ = #{value}
</select>

<!--  코스 QnA 상세보기 글 1개 조회 -->
<select id="courseQnASelect" parameterType="long" resultMap="courseListResultMap">
      SELECT  BRD_SEQ,
              BRD_TITLE,
              BRD_CONTENT,
              BRD_READ_CNT,
              BRD_PARENT,
              TO_CHAR(A.REG_DATE, 'YY.MM.DD HH24:MI') REG_DATE,
              MOD_DATE,
              DEL_DATE,
              A.COURSE_CODE,
              A.USER_ID,
              COURSE_NAME,
              USER_NAME,
              STATUS,
              RATING,
              USER_EMAIL,
              BRD_ORDER,
              BRD_GROUP
      FROM    EDU_COURSE_QNA A
      LEFT JOIN (
         SELECT   B.USER_ID USER_ID,
                  B.USER_NAME USER_NAME,
                  B.STATUS STATUS,
                  B.RATING RATING,
                  B.USER_EMAIL
          FROM    EDU_USER B
          
          UNION ALL
          
          SELECT  C.USER_ID USER_ID,
                  C.USER_NAME USER_NAME,
                  C.STATUS STATUS,
                  C.RATING RATING,
                  C.USER_EMAIL
          FROM    EDU_TEACHER C
      ) USER_DATE
      ON A.USER_ID = USER_DATE.USER_ID,
          EDU_COURSE C
      WHERE A.COURSE_CODE = C.COURSE_CODE
        AND BRD_SEQ = #{value}
        AND DEL_DATE IS NULL
</select>

<!-- 코스 QnA 게시글 첨부 파일 삭제 -->
<delete id="courseQnAFileDelete" parameterType="long">
   DELETE FROM EDU_COURSE_QNA_FILE
   WHERE  BRD_SEQ = #{value}
</delete>

<!-- 코스 QnA 게시글 수정 -->
<update id="courseQnAUpdate" parameterType="com.sist.web.model.CourseList">
   UPDATE EDU_COURSE_QNA
      SET BRD_TITLE = #{brdTitle},
          BRD_CONTENT = #{brdContent},
          MOD_DATE = SYSDATE
    WHERE BRD_SEQ = #{brdSeq}
</update>

<!--  코스 QnA 게시글 삭제 (UPDATE) -->
<update id="courseQnADelete" parameterType="long">
   UPDATE EDU_COURSE_QNA
      SET DEL_DATE = SYSDATE
    WHERE BRD_SEQ = #{brdSeq}
</update>

<!--  코스 QnA 게시판 게시글 조회 -->
<select id="courseQnAListCountM" parameterType="com.sist.web.model.CourseList" resultType="integer">

SELECT COUNT(BRD_SEQ)
FROM(
   SELECT  RNUM,
           BRD_SEQ,
           BRD_PARENT
   FROM    (SELECT ROWNUM RNUM,
                   BRD_SEQ,
                   BRD_PARENT
           FROM    (SELECT     BRD_SEQ,
                          BRD_PARENT
                  FROM    EDU_COURSE_QNA A
                  LEFT JOIN (
                     SELECT   B.USER_ID USER_ID,
                              B.USER_NAME USER_NAME,
                              B.STATUS STATUS,
                              B.RATING RATING
                      FROM    EDU_USER B
                      
                      UNION ALL
                      
                      SELECT  C.USER_ID USER_ID,
                              C.USER_NAME USER_NAME,
                              C.STATUS STATUS,
                              C.RATING RATING
                      FROM    EDU_TEACHER C
                      
                  <if test='courseCode == null and courseCode != "" and courseCode == 0'>
                      WHERE   C.USER_ID = ${userId}         
                  </if>    
                      
                  ) USER_DATE
                  ON A.USER_ID = USER_DATE.USER_ID,
                      EDU_COURSE C
                  WHERE A.COURSE_CODE = C.COURSE_CODE
                    AND   DEL_DATE IS NULL
                       AND  A.COURSE_CODE IN (SELECT COURSE_CODE 
                                            FROM EDU_COURSE 
                                            WHERE USER_ID = #{teacherId})
                       
                  <if test='courseCode != null and courseCode != "" and courseCode != 0'>       
                       AND  A.COURSE_CODE = #{courseCode}
                  </if>  
         
                       <if test='myBrdChk != null and myBrdChk != "" and myBrdChk == "Y"'>
                            AND A.BRD_GROUP IN (
                              SELECT BRD_GROUP
                              FROM EDU_COURSE_QNA
                              WHERE USER_ID = #{loginUserId}
                          )
                       </if>
                    
                        <if test='searchType != null and searchType != "" and searchValue != null and searchValue != ""'>
                            <choose>
                               <when test='searchType == "1"'>
                                 AND USER_NAME LIKE '%' || #{searchValue} || '%'
                               </when>
                                 
                               <when test='searchType == "2"'>
                                 AND BRD_TITLE LIKE '%' || #{searchValue} || '%'
                               </when>
                               
                               <when test='searchType == "3"'>
                                 AND DBMS_LOB.INSTR(BRD_CONTENT, #{searchValue}) > 0
                                </when>
                           </choose>
                      </if>  
                      
                      
                  ORDER BY BRD_GROUP DESC, BRD_ORDER))
                  
       WHERE BRD_PARENT = 0
       AND RNUM <![CDATA[>=]]> 0
           <if test='startRow > 0'>
       AND RNUM <![CDATA[<]]> #{startRow}
         </if>
         )
</select>





<!--  ############################################################################################### -->


<!--  코스 수강후기 게시판 리스트 조회 -->
<select id="courseReviewList" parameterType="com.sist.web.model.CourseList" resultMap="courseListResultMap">
      SELECT  BRD_SEQ,
              BRD_TITLE,
              BRD_CONTENT,
              BRD_READ_CNT,
              REG_DATE,
              MOD_DATE,
              DEL_DATE,
              BRD_RATING,
              COURSE_CODE,
              USER_ID,
              USER_NAME,
              COURSE_NAME
        FROM (SELECT  ROWNUM AS RNUM,
                      BRD_SEQ,
                      BRD_TITLE,
                      BRD_CONTENT,
                      BRD_READ_CNT,
                      REG_DATE,
                      MOD_DATE,
                      DEL_DATE,
                      BRD_RATING,
                      COURSE_CODE,
                      USER_ID,
                      USER_NAME,
                      COURSE_NAME
                FROM (SELECT  BRD_SEQ,
                              BRD_TITLE,
                              BRD_CONTENT,
                              BRD_READ_CNT,
                              TO_CHAR(A.REG_DATE, 'YYYY.MM.DD') REG_DATE,
                              A.MOD_DATE MOD_DATE,
                              A.DEL_DATE DEL_DATE,
                              BRD_RATING,
                              A.COURSE_CODE,
                              A.USER_ID USER_ID,
                              USER_NAME,
                              COURSE_NAME
                        FROM  EDU_COURSE_REVIEW A, EDU_USER B, EDU_COURSE C
                       WHERE  A.USER_ID = B.USER_ID
                         AND  A.COURSE_CODE = C.COURSE_CODE
                         AND  DEL_DATE IS NULL
                          AND  A.COURSE_CODE IN (SELECT COURSE_CODE 
                                       FROM  EDU_COURSE 
                                      WHERE  USER_ID = #{teacherId})
                         
      <if test='courseCode != null and courseCode != "" and courseCode != 0'>       
                       AND   A.COURSE_CODE = #{courseCode}
        </if>
                         
                  <if test='myBrdChk != null and myBrdChk != ""'>
                       AND  A.USER_ID = #{loginUserId}
                  </if>       
                         
                 <if test='searchType != null and searchType != "" and searchValue != null and searchValue != ""'>
                      <choose>
                         <when test='searchType == "1"'>
                           AND USER_NAME LIKE '%' || #{searchValue} || '%'
                         </when>
                           
                         <when test='searchType == "2"'>
                           AND BRD_TITLE LIKE '%' || #{searchValue} || '%'
                         </when>
                         
                         <when test='searchType == "3"'>
                           AND DBMS_LOB.INSTR(BRD_CONTENT, #{searchValue}) > 0
                          </when>
                     </choose>
                </if>  
                
                ORDER BY A.REG_DATE DESC))
                
        WHERE RNUM <![CDATA[>=]]> #{startRow}
          AND RNUM <![CDATA[<=]]> #{endRow}
</select>

<!--  코스 수강후기 게시판 글 수 조회 -->
<select id="courseReviewListCount" parameterType="com.sist.web.model.CourseList" resultType="long">
         SELECT COUNT(BRD_SEQ)
           FROM EDU_COURSE_REVIEW A, EDU_USER B
          WHERE A.USER_ID = B.USER_ID
            AND A.DEL_DATE IS NULL
            AND  A.COURSE_CODE IN (SELECT COURSE_CODE 
                                 FROM EDU_COURSE 
                                 WHERE USER_ID = #{teacherId})
            
        <if test='courseCode != null and courseCode != "" and courseCode != 0'>       
               AND   A.COURSE_CODE = #{courseCode}
        </if>
            
         <if test='myBrdChk != null and myBrdChk != ""'>
               AND  A.USER_ID = #{loginUserId}
        </if>   
            
           <if test='searchType != null and searchType != "" and searchValue != null and searchValue != ""'>
                <choose>
                   <when test='searchType == "1"'>
                     AND USER_NAME LIKE '%' || #{searchValue} || '%'
                   </when>
                     
                   <when test='searchType == "2"'>
                     AND BRD_TITLE LIKE '%' || #{searchValue} || '%'
                   </when>
                   
                   <when test='searchType == "3"'>
                     AND DBMS_LOB.INSTR(BRD_CONTENT, #{searchValue}) > 0
                    </when>
               </choose>
          </if>  
</select>

<!-- 수강 후기 작성 여부 -->
<select id="courseReviewWriteCheck" parameterType="map" resultType="int">
   SELECT NVL(COUNT(USER_ID),0) AS CNT
     FROM EDU_COURSE_REVIEW
    WHERE USER_ID = #{userId}
      AND COURSE_CODE = #{courseCode}
      AND DEL_DATE IS NULL
</select>


<!--  코스 수강후기 게시판 상세보기  -->
<select id="courseReviewView" parameterType="long" resultMap="courseListResultMap">
      SELECT  BRD_SEQ,
              BRD_TITLE,
              BRD_CONTENT,
              BRD_READ_CNT,
              TO_CHAR(A.REG_DATE, 'YYYY.MM.DD') REG_DATE,
              A.MOD_DATE MOD_DATE,
              A.DEL_DATE DEL_DATE,
              BRD_RATING,
              COURSE_CODE,
              A.USER_ID USER_ID,
              USER_EMAIL,
              USER_NAME,
              USER_PROFILE
      FROM    EDU_COURSE_REVIEW A, EDU_USER B
      WHERE   BRD_SEQ = #{value}
        AND   A.USER_ID = B.USER_ID
</select>

<!--  코스 수강후기 게시판 조회수 증가 -->
<update id="courseReviewReadCntPlus" parameterType="long">
      UPDATE EDU_COURSE_REVIEW
         SET BRD_READ_CNT = BRD_READ_CNT + 1
       WHERE BRD_SEQ = #{value}
</update>

<!--  코스 수강후기 게시판 글 등록 -->
<insert id="courseReviewInsert" parameterType="com.sist.web.model.CourseList">

   <selectKey resultType="long"  keyProperty="brdSeq" order="BEFORE">
      SELECT SEQ_COURSE_REVIEW_SEQ.NEXTVAL FROM DUAL
   </selectKey>

      INSERT INTO EDU_COURSE_REVIEW (
          BRD_SEQ,
          BRD_TITLE,
          BRD_CONTENT,
          BRD_READ_CNT,
          REG_DATE,
          MOD_DATE,
          DEL_DATE,
          BRD_RATING,
          COURSE_CODE,
          USER_ID
      ) VALUES (
           #{brdSeq},
           #{brdTitle},
           #{brdContent},
           0,
           SYSDATE,
           NULL,
           NULL,
           #{brdRating},
           #{courseCode},
           #{userId}
      )

</insert>

<!--  코스 수강후기 글 수정 -->
<update id="courseReviewUpdate" parameterType="com.sist.web.model.CourseList">
         UPDATE EDU_COURSE_REVIEW
            SET BRD_TITLE = #{brdTitle},
                BRD_CONTENT = #{brdContent},
                BRD_RATING = #{brdRating},
                MOD_DATE = SYSDATE
          WHERE BRD_SEQ = #{brdSeq}
</update>

<!--  코스 수강후기 글 삭제 -->
<update id="courseReviewDelete" parameterType="long">
         UPDATE EDU_COURSE_REVIEW
            SET DEL_DATE = SYSDATE
          WHERE BRD_SEQ = ${brdSeq}
</update>

<!-- 베스트 수강후기 3개 뽑기 (조회순) -->
<select id="teachBestReview" parameterType="String" resultMap="courseListResultMap">
      SELECT
          RNUM,
          BRD_SEQ,
          BRD_TITLE,
          BRD_CONTENT,
          BRD_READ_CNT,
          REG_DATE,
          MOD_DATE,
          DEL_DATE,
          BRD_RATING,
          COURSE_CODE,
          USER_ID,
          USER_NAME,
          USER_PROFILE
      FROM
          (SELECT
              ROWNUM RNUM,
              BRD_SEQ,
              BRD_TITLE,
              BRD_CONTENT,
              BRD_READ_CNT,
              REG_DATE,
              MOD_DATE,
              DEL_DATE,
              BRD_RATING,
              COURSE_CODE,
              USER_ID,
              USER_NAME,
              USER_PROFILE
          FROM
              (SELECT
                  BRD_SEQ,
                  BRD_TITLE,
                  BRD_CONTENT,
                  BRD_READ_CNT,
                  TO_CHAR(A.REG_DATE, 'YY.MM.DD') REG_DATE,
                  A.MOD_DATE MOD_DATE,
                  A.DEL_DATE DEL_DATE,
                  BRD_RATING,
                  COURSE_CODE,
                  A.USER_ID USER_ID,
                  B.USER_NAME USER_NAME,
                  B.USER_PROFILE USER_PROFILE
              FROM
                  EDU_COURSE_REVIEW A, EDU_USER B
              WHERE
                  A.USER_ID = B.USER_ID
              AND 
                  A.COURSE_CODE IN (SELECT COURSE_CODE 
                                FROM  EDU_COURSE 
                               WHERE  USER_ID = #{value})
            AND
               A.DEL_DATE IS NULL
              ORDER BY
                  BRD_READ_CNT DESC))
      WHERE
          RNUM <![CDATA[>=]]> 1
      AND
          RNUM <![CDATA[<=]]> 3
</select>


</mapper>
